pipeline {
    agent any

    environment {
        IMAGE = "sham9394/cityzen"
        IMAGE_TAG = "${BUILD_NUMBER}"
        INFRA_REPO = "https://github.com/sham9394/infra-repo.git"
        CODE_REPO = "https://github.com/sham9394/code-repo.git"
        K8S_NAMESPACE = "default"
        DEPLOYMENT_FILE = "/root/home/workspace/End-to-End-deployment-pipeline/K8s/deployment.yml"
    }

    stages {
        stage('check Infrastructure..') {
            agent { label 'docker-agent' }

            when {
                expression {
                    sh(script: "kubectl cluster-info >/dev/null 2>&1", returnStatus: true) != 0
                }
            }

            steps {
                echo "Cluster not found... Running infra setup next stage."
            }
        }
        stage('Setup Infrastructure..') {
            steps {
                script {
                    echo "Running Ansible playbook..."
                    git url: "${INFRA_REPO}", branch: 'main'

                    sh '''
                        cd "$WORKSPACE/Ansible"
                        ansible-playbook -i inventory.ini cleanup-k8s.yml
                        cd "$WORKSPACE/Ansible"
                        ansible-playbook -i inventory.ini k8s-clusters-setup.yml
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            agent { label 'docker-agent' }
            steps {

                echo "üîπ Pulling code-repo and preparing Docker"
                git url: "${CODE_REPO}", branch: 'main'

                sh '''
                    echo "üîç Checking if Docker is installed..."

                    if command -v docker >/dev/null 2>&1; then
                        echo "‚úî Docker is already installed"
                    else
                        echo "‚ùå Docker not found ‚Äî installing docker.io"
                        sudo apt-get update -y
                        sudo apt-get install -y docker.io
                        sudo systemctl enable docker
                        sudo systemctl start docker
                        echo "‚úî Docker installation completed"
                    fi
                '''

                sh '''
                    echo "üöÄ Building Docker image ${IMAGE}:${IMAGE_TAG}"
                    cd frontend
                    docker build -t ${IMAGE}:${IMAGE_TAG} .
                '''
            }
        }

        stage('Push Docker Image') {
            agent { label 'docker-agent' }
            steps {
                echo "üîπ Pushing Docker image and tagging as latest"

                withCredentials([
                    usernamePassword(
                        credentialsId: 'dockerhub',
                        usernameVariable: 'DOCKERHUB_USERNAME',
                        passwordVariable: 'DOCKERHUB_PASSWORD'
                    )
                ]) {
                    sh """
                        echo \$DOCKERHUB_PASSWORD | docker login -u \$DOCKERHUB_USERNAME --password-stdin

                        docker push ${IMAGE}:${IMAGE_TAG}
                        docker tag ${IMAGE}:${IMAGE_TAG} ${IMAGE}:latest
                        docker push ${IMAGE}:latest

                        docker rmi ${IMAGE}:${IMAGE_TAG} || true
                        docker rmi ${IMAGE}:latest || true
                    """
                }
            }
        }

        stage('Deploy to Kubernetes') {
            agent { label 'docker-agent' }
            steps {
                echo "üîπ Updating deployment.yml with latest Docker image"

                sh """
                    sed -i 's|image:.*|image: ${IMAGE}:${IMAGE_TAG}|' ${DEPLOYMENT_FILE}
                    kubectl apply -f ${DEPLOYMENT_FILE} -n ${K8S_NAMESPACE}
                    kubectl rollout status deployment/cityzen-frontend -n ${K8S_NAMESPACE}
                """
            }
        }

    } // END stages

    post {
        success {
            echo "‚úÖ Pipeline completed successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed. Check logs!"
        }
    }
}
